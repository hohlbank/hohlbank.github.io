<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hohl Bank</title>
</head>
<body>

<!-- ВАЖНО: твой весь HTML и CSS остаётся прежним -->
<!-- Я показываю только рабочую JS-часть, чтобы не ломать верстку -->

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase конфигурация
const firebaseConfig = {
    apiKey: "AIzaSyAQMCpOIf5eJYzD0ACbM8ZnfzNItjN8PZA",
    authDomain: "hohlbank.firebaseapp.com",
    databaseURL: "https://hohlbank-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hohlbank",
    storageBucket: "hohlbank.firebasestorage.app",
    messagingSenderId: "792378699838",
    appId: "1:792378699838:web:4ab670b39a7f9bd550a16f"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentUsername = '';
let balanceVisible = true;

window.onload = function() {
    const session = localStorage.getItem('hohlgramSession');
    if (session) {
        const userData = JSON.parse(session);
        showDashboard(userData);
    }
};

// ================= LOGIN ЧЕРЕЗ FIREBASE =================

async function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        showMessage('Введите логин и пароль', 'error');
        return;
    }

    try {
        const snapshot = await database.ref('users/' + username).once('value');
        const user = snapshot.val();

        if (!user) {
            showMessage('Пользователь не найден', 'error');
            return;
        }

        if (user.password !== password) {
            showMessage('Неверный пароль', 'error');
            return;
        }

        const userData = {
            username: username,
            name: user.name,
            loginTime: new Date().toLocaleString('ru-RU')
        };

        currentUsername = username;
        localStorage.setItem('hohlgramSession', JSON.stringify(userData));

        showMessage('Вход выполнен успешно!', 'success');

        setTimeout(() => {
            showDashboard(userData);
        }, 800);

    } catch (error) {
        console.error(error);
        showMessage('Ошибка подключения к серверу', 'error');
    }
}

// ================= СОЗДАНИЕ КАРТЫ =================

function generateCardNumber() {
    let number = '4532 ';
    for (let i = 0; i < 3; i++) {
        number += Math.floor(1000 + Math.random() * 9000) + ' ';
    }
    return number.trim();
}

async function createCard() {

    const userSnapshot = await database.ref('users/' + currentUsername).once('value');
    const userName = userSnapshot.val().name;

    const newCard = {
        number: generateCardNumber(),
        name: userName,
        balance: 0
    };

    await database.ref('cards/' + currentUsername).set(newCard);
    showCard(newCard);
}

// ================= ПЕРЕВОД =================

async function processTransfer(type) {

    let recipient, amount;

    if (type === 'nickname') {
        recipient = document.getElementById('recipientNickname').value.trim();
        amount = parseFloat(document.getElementById('amountNickname').value);
    } else {
        recipient = document.getElementById('recipientCard').value.trim().replace(/\s/g, '');
        amount = parseFloat(document.getElementById('amountCard').value);
    }

    if (!recipient || !amount || amount < 1) {
        alert('Заполните все поля корректно');
        return;
    }

    const senderSnapshot = await database.ref('cards/' + currentUsername).once('value');
    const senderCard = senderSnapshot.val();

    if (!senderCard || senderCard.balance < amount) {
        alert('Недостаточно средств');
        return;
    }

    let recipientUsername = null;

    if (type === 'nickname') {

        const recipientSnapshot = await database.ref('users/' + recipient).once('value');

        if (!recipientSnapshot.exists()) {
            alert('Пользователь не найден');
            return;
        }

        recipientUsername = recipient;

    } else {

        const cardsSnapshot = await database.ref('cards').once('value');
        const allCards = cardsSnapshot.val();

        for (let username in allCards) {
            if (allCards[username].number.replace(/\s/g, '') === recipient) {
                recipientUsername = username;
                break;
            }
        }

        if (!recipientUsername) {
            alert('Карта не найдена');
            return;
        }
    }

    if (recipientUsername === currentUsername) {
        alert('Нельзя переводить самому себе');
        return;
    }

    const recipientSnapshot = await database.ref('cards/' + recipientUsername).once('value');
    const recipientCard = recipientSnapshot.val();

    const updates = {};
    updates['cards/' + currentUsername + '/balance'] = senderCard.balance - amount;
    updates['cards/' + recipientUsername + '/balance'] = recipientCard.balance + amount;

    await database.ref().update(updates);

    alert('Перевод выполнен!');
}

// ================= ВЫХОД =================

function handleLogout() {
    localStorage.removeItem('hohlgramSession');
    location.reload();
}

</script>
</body>
</html>
