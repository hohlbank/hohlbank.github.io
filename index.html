<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hohl Bank</title>
</head>
<body>

<div id="login">
    <h2>Вход</h2>
    <form onsubmit="handleLogin(event)">
        <input type="text" id="username" placeholder="Логин" required><br><br>
        <input type="password" id="password" placeholder="Пароль" required><br><br>
        <button type="submit">Войти</button>
    </form>
    <div id="message"></div>
</div>

<div id="dashboard" style="display:none;">
    <h2>Личный кабинет</h2>
    <p>Пользователь: <strong id="currentUser"></strong></p>
    <p>Ник: <strong id="currentNickname"></strong></p>
    <p>Время входа: <strong id="loginTime"></strong></p>
    <button onclick="handleLogout()">Выйти</button>
    <hr>
    <button onclick="createCard()">Создать карту</button>
    <div id="cardInfo"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAQMCpOIf5eJYzD0ACbM8ZnfzNItjN8PZA",
    authDomain: "hohlbank.firebaseapp.com",
    databaseURL: "https://hohlbank-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hohlbank",
    storageBucket: "hohlbank.firebasestorage.app",
    messagingSenderId: "792378699838",
    appId: "1:792378699838:web:4ab670b39a7f9bd550a16f"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentUsername = "";

function showMessage(text, color="red") {
    const el = document.getElementById("message");
    el.innerText = text;
    el.style.color = color;
}

async function handleLogin(event) {
    event.preventDefault();

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!username || !password) {
        showMessage("Введите логин и пароль");
        return;
    }

    try {
        const snapshot = await database.ref("users/" + username).once("value");
        const user = snapshot.val();

        if (!user) {
            showMessage("Пользователь не найден");
            return;
        }

        if (user.password !== password) {
            showMessage("Неверный пароль");
            return;
        }

        const userData = {
            username: username,
            name: user.name,
            loginTime: new Date().toLocaleString("ru-RU")
        };

        localStorage.setItem("hohlgramSession", JSON.stringify(userData));
        currentUsername = username;

        document.getElementById("login").style.display = "none";
        document.getElementById("dashboard").style.display = "block";

        document.getElementById("currentUser").innerText = user.name;
        document.getElementById("currentNickname").innerText = username;
        document.getElementById("loginTime").innerText = userData.loginTime;

        loadUserCard();

    } catch (error) {
        console.error(error);
        showMessage("Ошибка подключения к серверу");
    }
}

function handleLogout() {
    localStorage.removeItem("hohlgramSession");
    location.reload();
}

function generateCardNumber() {
    let number = "4532 ";
    for (let i = 0; i < 3; i++) {
        number += Math.floor(1000 + Math.random() * 9000) + " ";
    }
    return number.trim();
}

async function createCard() {
    const userSnapshot = await database.ref("users/" + currentUsername).once("value");
    const userName = userSnapshot.val().name;

    const newCard = {
        number: generateCardNumber(),
        name: userName,
        balance: 0
    };

    await database.ref("cards/" + currentUsername).set(newCard);
    loadUserCard();
}

async function loadUserCard() {
    const snapshot = await database.ref("cards/" + currentUsername).once("value");
    const card = snapshot.val();

    if (!card) {
        document.getElementById("cardInfo").innerHTML = "<p>Карты нет</p>";
        return;
    }

    document.getElementById("cardInfo").innerHTML = `
        <p><strong>Номер:</strong> ${card.number}</p>
        <p><strong>Владелец:</strong> ${card.name}</p>
        <p><strong>Баланс:</strong> ${card.balance} ₽</p>
    `;
}

window.onload = function() {
    const session = localStorage.getItem("hohlgramSession");
    if (session) {
        const userData = JSON.parse(session);
        currentUsername = userData.username;

        document.getElementById("login").style.display = "none";
        document.getElementById("dashboard").style.display = "block";

        document.getElementById("currentUser").innerText = userData.name;
        document.getElementById("currentNickname").innerText = userData.username;
        document.getElementById("loginTime").innerText = userData.loginTime;

        loadUserCard();
    }
};
</script>

</body>
</html>
